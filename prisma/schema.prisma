// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Province {
  id             String           @id @default(cuid())
  name           String
  longitude      Float
  latitude       Float
  geoId          String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  cities         City[]
  schools        School[]
  users          User[]
  adminAuthority AdminAuthority[]
  bannerLocation BannerLocation[]
  admin          Admin[]

  @@index([id])
  @@index([name])
  @@index([id, name])
}

model City {
  id             String           @id @default(cuid())
  name           String
  longitude      Float
  latitude       Float
  geoId          String
  provinceId     String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  province       Province         @relation(fields: [provinceId], references: [id])
  schools        School[]
  users          User[]
  adminAuthority AdminAuthority[]
  bannerLocation BannerLocation[]
  admin          Admin[]

  @@index([provinceId])
}

model School {
  id             String           @id @default(cuid())
  identity       String
  name           String
  longitude      Float
  latitude       Float
  cityId         String
  provinceId     String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  city           City             @relation(fields: [cityId], references: [id])
  province       Province         @relation(fields: [provinceId], references: [id])
  users          User[]
  adminAuthority AdminAuthority[]
  admin          Admin[]

  @@index([cityId])
}

model User {
  id                  String               @id @default(cuid())
  authId              String               @unique
  email               String               @unique
  role                Role                 @default(User)
  suspend             Boolean              @default(false)
  accountType         AccountType          @default(Self)
  firstTest           Boolean              @default(false)
  fullname            String               @default("")
  birthDate           DateTime?
  grade               Int                  @default(0)
  lastGradeUpdateAt   DateTime?
  schoolIdentity      String               @unique
  loginAt             DateTime?
  logoutAt            DateTime?
  playTime            Int                  @default(0)
  characterUsed       String               @default("")
  inventory           Int[]                @default([0, 0, 0])
  schoolId            String?
  cityId              String?
  provinceId          String?
  adminId             String?              @unique
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  username            String               @unique
  lastIdZoneUnlocked  String               @default("")
  lastIdZonePosition  String               @default("")
  city                City?                @relation(fields: [cityId], references: [id])
  province            Province?            @relation(fields: [provinceId], references: [id])
  school              School?              @relation(fields: [schoolId], references: [id])
  admin               Admin?               @relation(fields: [adminId], references: [id], onDelete: Cascade)
  zones               Zone[]
  userLogin           UserLogin[]
  bannerVisitor       BannerVisitor[]
  testParticipant     TestParticipant[]
  //voucherRedemeer     VoucherRedemeer[]
  //userTransactionArchive UserTransactionArchive[]
  //userTransaction        UserTransaction[]
  multiPlayerMember   MultiPlayerMember[]
  //testRecords            TestParticipantRecord[]
  subLevels           SubLevel[]
  innerLevels         InnerLevel[]
  levels              Level[]
  gempos              Gempo[]
  championships       Championship[]
  gempoRecords        GempoRecord[]
  championshipRecords ChampionshipRecord[]
  redemeedCodes       CodeRedemeer[]

  @@index([authId])
}

model Zone {
  id               String    @id @default(cuid())
  inGameId         String
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  isComplete       Boolean   @default(false)
  completedAt      DateTime?
  lastLevelId      String    @default("")
  lastSubLevelId   String    @default("")
  lastInnerLevelId String    @default("")
  lastLevelUnlock  String    @default("")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, inGameId])
  @@index([inGameId])
  @@index([userId])
}

model Level {
  id           String    @id @default(cuid())
  inGameId     String
  zoneInGameId String
  isUnlock     Boolean   @default(false)
  unlockedAt   DateTime?
  isComplete   Boolean   @default(false)
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId])
  @@index([inGameId])
  @@index([userId])
}

model SubLevel {
  id            String    @id @default(cuid())
  inGameId      String
  zoneInGameId  String
  levelInGameId String
  isUnlock      Boolean   @default(false)
  unlockedAt    DateTime?
  isComplete    Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId])
  @@index([levelInGameId])
  @@index([inGameId])
  @@index([userId])
}

model InnerLevel {
  id               String    @id @default(cuid())
  inGameId         String
  zoneInGameId     String
  levelInGameId    String
  subLevelInGameId String
  isUnlock         Boolean   @default(false)
  unlockedAt       DateTime?
  isComplete       Boolean   @default(false)
  completedAt      DateTime?
  correctAttempt   Float     @default(0)
  playTime         Int       @default(0)
  point            Int       @default(0)
  played           Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId])
  @@index([levelInGameId])
  @@index([subLevelInGameId])
  @@index([inGameId])
  @@index([userId])
}

model Gempo {
  id           String    @id @default(cuid())
  isUnlock     Boolean   @default(false)
  unlockedAt   DateTime?
  inGameId     String
  zoneInGameId String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId, inGameId])
  @@index([zoneInGameId])
  @@index([inGameId])
  @@index([userId])
}

model Championship {
  id           String    @id @default(cuid())
  isUnlock     Boolean   @default(false)
  unlockedAt   DateTime?
  inGameId     String
  zoneInGameId String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId, inGameId])
  @@index([zoneInGameId])
  @@index([inGameId])
  @@index([userId])
}

model GempoRecord {
  id            String    @id @default(cuid())
  inGameId      String // in-game id ex: G02
  zoneInGameId  String
  gempoInGameId String
  played        Int       @default(0)
  point         Int       @default(0)
  lastPlayedAt  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId, gempoInGameId])
  @@index([gempoInGameId, inGameId])
  @@index([gempoInGameId])
  @@index([zoneInGameId])
  @@index([inGameId])
  @@index([userId])
}

model ChampionshipRecord {
  id                   String    @id @default(cuid())
  inGameId             String // in-game id
  zoneInGameId         String
  championshipInGameId String
  teamWin              Int       @default(0)
  teamLose             Int       @default(0)
  teamPlayed           Int       @default(0)
  teamPoint            Int       @default(0)
  teamLastPlayedAt     DateTime?
  soloWin              Int       @default(0)
  soloLose             Int       @default(0)
  soloPlayed           Int       @default(0)
  soloPoint            Int       @default(0)
  soloLastPlayedAt     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, inGameId])
  @@index([zoneInGameId, championshipInGameId])
  @@index([championshipInGameId, inGameId])
  @@index([championshipInGameId])
  @@index([zoneInGameId])
  @@index([inGameId])
  @@index([userId])
}

model UserLogin {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id])
  loginDate  DateTime
  logoutDate DateTime?

  @@index([userId])
}

model Admin {
  id                   String                  @id @default(cuid())
  authId               String                  @unique
  email                String                  @unique
  name                 String
  suspend              Boolean                 @default(false)
  role                 Role?
  user                 User?
  provinceId           String?
  cityId               String?
  schoolId             String?
  province             Province?               @relation(fields: [provinceId], references: [id])
  city                 City?                   @relation(fields: [cityId], references: [id])
  school               School?                 @relation(fields: [schoolId], references: [id])
  authority            AdminAuthority[]
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  operationHistories   AdminOperationHistory[] @relation("OperationHistory")
  operations           AdminOperationHistory[] @relation("Operations")
  banner               Banner[]
  transactions         AdminTransaction[]      @relation("transactions")
  transactionProcessed AdminTransaction[]      @relation("transactionProcessed")
  redeemCodes          RedeemCode[]
}

model AdminOperationHistory {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  adminId   String
  admin     Admin     @relation("OperationHistory", fields: [adminId], references: [id], onDelete: Cascade)
  opAdminId String
  opAdmin   Admin     @relation("Operations", fields: [opAdminId], references: [id], onDelete: Cascade)
  operation Operation @default(None)
}

model AdminAuthority {
  id         String   @id @default(cuid())
  adminId    String
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  provinceId String
  province   Province @relation(fields: [provinceId], references: [id])
  cities     City[]
  schools    School[]
  grades     Int[]

  @@index([provinceId])
}

model Banner {
  id             String           @id @default(cuid())
  thumbnailId    String
  thumbnail      String
  link           String?
  startedAt      DateTime?
  endedAt        DateTime?
  isHide         Boolean          @default(false)
  visitors       BannerVisitor[]
  adminId        String
  admin          Admin            @relation(fields: [adminId], references: [id])
  bannerLocation BannerLocation[]
}

model BannerLocation {
  id         String   @id @default(cuid())
  bannerId   String
  banner     Banner   @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  provinceId String
  province   Province @relation(fields: [provinceId], references: [id])
  cities     City[]
}

model BannerVisitor {
  id        String   @id @default(cuid())
  bannerId  String   @unique
  banner    Banner   @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  traffic   Int      @default(0)
}

model Test {
  id            String            @id @default(cuid())
  name          String            @default("")
  category      Role
  question      QuestionType
  duration      Int               @default(0)
  passedPoint   Int               @default(0)
  remidialCount Int               @default(-1)
  type          TestType
  quota         Int               @default(-1)
  currentQuota  Int               @default(-1)
  code          String?
  zoneId        String?
  startedAt     DateTime
  endedAt       DateTime?
  description   String?
  participants  TestParticipant[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([category])
  @@index([category, type, question, startedAt, endedAt])
}

model TestParticipant {
  id          String                  @id @default(cuid())
  testId      String
  test        Test                    @relation(fields: [testId], references: [id], onDelete: Cascade)
  userId      String
  user        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstTimeAt DateTime?
  lastTestAt  DateTime?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  highscore   Float                   @default(0)
  records     TestParticipantRecord[]

  @@unique([testId, userId])
}

model TestParticipantRecord {
  id            String          @id @default(cuid())
  participantId String
  participant   TestParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  startedAt     DateTime?
  endedAt       DateTime?
  score         Float           @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  //userId        String
  //user          User            @relation(fields: [userId], references: [id])
  answers       Json
  //@@index([userId])
  //@@index([participantId, userId])

  @@index([participantId])
}

model Background {
  id          String   @id @default(cuid())
  name        String
  thumbnailId String
  thumbnail   String
  isUse       Boolean
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Setting {
  id        String   @id @default(cuid())
  name      String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// model Voucher {
//   id           Int               @id @default(autoincrement())
//   code         String            @unique
//   quota        Int               @default(0)
//   currentQuota Int               @default(0)
//   startedAt    DateTime
//   endedAt      DateTime?
//   type         VoucherType       @default(Discount)
//   zones        String[]
//   redemeers    VoucherRedemeer[]
// }
//
// model VoucherRedemeer {
//   id        Int      @id @default(autoincrement())
//   createdAt DateTime @default(now())
//   voucherId Int
//   voucher   Voucher  @relation(fields: [voucherId], references: [id])
//   userId    String
//   user      User     @relation(fields: [userId], references: [id])
// }

model AdminTransaction {
  id                  String      @id @default(cuid())
  name                String
  status              Transaction @default(Pending)
  archived            Boolean     @default(false)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  adminId             String
  admin               Admin       @relation("transactions", fields: [adminId], references: [id])
  quantity            Int         @default(0)
  subscriptionTime    Int
  zones               String[]
  transactionRef      String?
  amount              Int
  description         String?
  transactionImageId  String?
  transactionImageUrl String?
  redeemCode          RedeemCode?
  processedById       String?
  processedBy         Admin?      @relation("transactionProcessed", fields: [processedById], references: [id])
  processedAt         DateTime?

  @@index([name])
  @@index([status])
  @@index([adminId])
  @@index([transactionRef])
  @@index([archived])
}

model RedeemCode {
  id            String           @id @default(cuid())
  suspend       Boolean          @default(false)
  transactionId String           @unique
  transaction   AdminTransaction @relation(fields: [transactionId], references: [id])
  adminId       String
  admin         Admin            @relation(fields: [adminId], references: [id])
  redemeers     CodeRedemeer[]
  code          String           @unique @default(cuid())
  expiredAt     DateTime
  currentAmount Int
  maxAmount     Int
  data          String[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([adminId])
}

model CodeRedemeer {
  id        String     @id @default(cuid())
  banned    Boolean    @default(false)
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  codeId    String
  code      RedeemCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([id, userId])
  @@unique([codeId, userId])
  @@index([codeId])
  @@index([userId])
  @@index([banned])
  @@index([codeId, userId])
  @@index([codeId, banned])
}

// model AdminTransactionArchive {
//   id              String   @id @default(cuid())
//   transactionName String
//   status          String
//   createdAt       DateTime @default(now())
//   expiredAt       DateTime
//   updatedAt       DateTime @updatedAt
//   customerEmail   String
//   customerName    String
//   customerId      String
//   customer        Admin    @relation(fields: [customerId], references: [id])
//   quantity        Int      @default(0)
//   zones           String[]
// }

// model UserTransaction {
//   id              String   @id @default(cuid())
//   transactionName String
//   status          String
//   createdAt       DateTime @default(now())
//   expiredAt       DateTime
//   updatedAt       DateTime @updatedAt
//   customerEmail   String
//   customerName    String
//   customerId      String
//   customer        User     @relation(fields: [customerId], references: [id])
//   quantity        Int      @default(0)
//   zones           String[]
// }

// model UserTransactionArchive {
//   id              String   @id @default(cuid())
//   transactionName String
//   status          String
//   createdAt       DateTime @default(now())
//   expiredAt       DateTime
//   updatedAt       DateTime @updatedAt
//   customerEmail   String
//   customerName    String
//   customerId      String
//   customer        User     @relation(fields: [customerId], references: [id])
//   quantity        Int      @default(0)
//   zones           String[]
// }

model MultiplayerRoom {
  id            String              @id @default(cuid())
  max           Int                 @default(2)
  gameplayId    String              @unique
  botOwner      String
  startedAt     DateTime?
  endedAt       DateTime?
  expiredAt     DateTime?
  isStarted     Boolean             @default(false)
  isEnded       Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  currentMember Int                 @default(0)
  members       MultiPlayerMember[]

  @@index([max])
  @@index([max, startedAt])
  @@index([max, startedAt, currentMember])
}

model MultiPlayerMember {
  id           String    @id @default(cuid())
  roomId       String
  userId       String
  point        Int       @default(0)
  bonusPoint   Int       @default(0)
  isReady      Boolean   @default(false)
  isComplete   Boolean   @default(false)
  isBot        Boolean   @default(false)
  joinedAt     DateTime  @default(now())
  finishedAt   DateTime?
  isDisconnect Boolean   @default(false)

  user User            @relation(fields: [userId], references: [id])
  room MultiplayerRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

enum Role {
  Developer
  SuperAdmin
  Admin
  SchoolAdmin
  Teacher
  User
}

enum AccountType {
  LMS
  Self
}

enum VoucherType {
  Discount
  FixedPrice
}

enum QuestionType {
  Addition
  Multiplication
  Subtraction
  Division
  Bakalkubagi
}

enum TestType {
  PreTest
  PostTest
  FirstPreTest
  Contest
}

enum Operation {
  None
  Create
  Update
  Delete
}

enum Transaction {
  Pending
  Cancelled
  Settlement
}
